<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weatherly - Detailed Alert</title>
<link rel="stylesheet" href="stylesheet/global.css">
<link rel="stylesheet" href="stylesheet/detailedAlert.css">
<script src="mockdata.js"></script>
</head>
<body>

<!-- Top Navigation -->
<header class="top-nav">
  <div class="logo">â˜ï¸ <h1>Weatherly</h1></div>
  <nav class="nav-links">
    <a href="saved.html">Dashboard</a>
    <a href="search.html">Search</a>
    <a href="pastWeather.html">Past Weather</a>
    <a href="weatherAlerts.html" class="active" >Alerts</a>
    <a href="settings.html">Settings</a>
    <a href="help.html">Help</a>
  </nav>
  <div class="user-section">
    <button onclick="window.location.href='profile.html'" class="profile-btn">Demo User</button>
    <button onclick="window.location.href='login.html'" class="logout-btn">Logout</button>
  </div>
</header>

<main class="main-container">

  <a href="weatherAlerts.html" class="back-link">
    â† Back to Alerts
  </a>

  <!-- Alert Header -->
  <div id="alertHeader" class="alert-header-card">
    <div id="alertIcon" class="alert-icon-large">âš ï¸</div>
    <div class="alert-info">
      <div class="alert-title-row">
        <h2 id="alertTitle">Severe Thunderstorm Warning</h2>
        <span id="alertBadge" class="alert-badge-detail">Severe</span>
      </div>
      <div class="alert-location">
        ğŸ“ <span id="alertLocation">New York, USA</span>
      </div>
    </div>
    <button id="shareBtn" class="share-btn">ğŸ“¤ Share</button>
  </div>

  <div class="grid alert-details-grid">
    <!-- Left/Main Column -->
    <div class="main-column">
      <div class="card">
        <h3>Alert Description</h3>
        <p id="alertDescription"></p>
      </div>

      <div id="instructionsCard" class="card instructions-card hidden">
        <h3>â“˜ Safety Instructions</h3>
        <ul id="instructionsList"></ul>
      </div>

      <div id="areasCard" class="card hidden">
        <h3>Affected Areas</h3>
        <div id="affectedAreas" class="badge-container"></div>
      </div>

      <div id="detailsCard" class="card hidden">
        <h3>Expected Conditions</h3>
        <div class="grid-conditions" id="weatherConditions"></div>
      </div>
    </div>

    <!-- Sidebar Column -->
    <div class="sidebar-column">
      <div class="card">
        <h3>Time Details</h3>
        <div class="time-detail-item">
          <span class="time-icon">ğŸ—“ï¸</span>
          <div>
            <strong>Issued:</strong> <span id="issuedTime"></span>
          </div>
        </div>
        <div class="time-detail-item">
          <span class="time-icon">ğŸ•’</span>
          <div>
            <strong>Effective Period:</strong> <span id="effectivePeriod"></span>
          </div>
        </div>
      </div>

      <div id="classificationCard" class="card hidden">
        <h3>Alert Classification</h3>
        <div class="classification-item">
          <strong>Severity</strong> <span id="severity" class="classification-badge"></span>
        </div>
        <div class="classification-item">
          <strong>Urgency</strong> <span id="urgency" class="classification-badge"></span>
        </div>
        <div class="classification-item">
          <strong>Certainty</strong> <span id="certainty" class="classification-badge"></span>
        </div>
      </div>

      <div id="issuedByCard" class="card hidden">
        <h3>Issued By</h3>
        <p id="issuedBy"></p>
      </div>
    </div>
  </div>

</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Get alert ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const alertId = parseInt(urlParams.get('id')) || 1;

  // Function to get alert data
  function getAlertData() {
    // Try localStorage first
    try {
      const stored = localStorage.getItem("detailedAlertsData");
      if (stored) {
        const parsed = JSON.parse(stored);
        if (parsed && Object.keys(parsed).length > 0) {
          return parsed;
        }
      }
    } catch (e) {
      console.warn("Could not parse localStorage data", e);
    }

    // Fallback to global variable
    if (typeof window.detailedAlertsData !== 'undefined' && window.detailedAlertsData) {
      return window.detailedAlertsData;
    }

    return null;
  }

  // Get data with retry
  let detailedAlertsData = getAlertData();
  
  if (!detailedAlertsData || Object.keys(detailedAlertsData).length === 0) {
    // Wait a bit for mockdata.js to initialize
    setTimeout(() => {
      detailedAlertsData = getAlertData();
      if (detailedAlertsData && Object.keys(detailedAlertsData).length > 0) {
        loadAlertData(alertId, detailedAlertsData);
      } else {
        console.error("Alert data not found. Available data:", detailedAlertsData);
        console.log("Trying to initialize...");
        // Force initialization
        if (typeof initializeWeatherlyMockData === 'function') {
          initializeWeatherlyMockData();
          detailedAlertsData = getAlertData();
          if (detailedAlertsData) {
            loadAlertData(alertId, detailedAlertsData);
          }
        }
      }
    }, 100);
    return;
  }

  loadAlertData(alertId, detailedAlertsData);
});

function loadAlertData(alertId, detailedAlertsData) {
  const alert = detailedAlertsData[alertId];

  if (!alert) {
    console.error("Alert not found for ID:", alertId);
    console.log("Available alerts:", Object.keys(detailedAlertsData));
    // Don't redirect, just show error
    return;
  }

  // DOM elements
  const alertIcon = document.getElementById('alertIcon');
  const alertTitle = document.getElementById('alertTitle');
  const alertBadge = document.getElementById('alertBadge');
  const alertLocation = document.getElementById('alertLocation');
  const alertDescription = document.getElementById('alertDescription');
  const instructionsCard = document.getElementById('instructionsCard');
  const instructionsList = document.getElementById('instructionsList');
  const areasCard = document.getElementById('areasCard');
  const affectedAreas = document.getElementById('affectedAreas');
  const detailsCard = document.getElementById('detailsCard');
  const weatherConditions = document.getElementById('weatherConditions');
  const issuedTime = document.getElementById('issuedTime');
  const effectivePeriod = document.getElementById('effectivePeriod');
  const classificationCard = document.getElementById('classificationCard');
  const severity = document.getElementById('severity');
  const urgency = document.getElementById('urgency');
  const certainty = document.getElementById('certainty');
  const issuedByCard = document.getElementById('issuedByCard');
  const issuedBy = document.getElementById('issuedBy');
  const shareBtn = document.getElementById('shareBtn');
  const alertHeader = document.getElementById('alertHeader');

  // Apply colors based on severity type
  const alertColors = { 
    severe: {bg: '#fee2e2', text: '#b91c1c', border: '#ff7b7b'},
    moderate: {bg: '#ffedd5', text: '#ea580c', border: '#f9b997'},
    info: {bg: '#dbeafe', text: '#1e40af', border: '#5c82ff'}
  };
  
  const colorScheme = alertColors[alert.type] || alertColors.severe;
  alertIcon.style.backgroundColor = colorScheme.bg;
  alertIcon.style.color = colorScheme.text;
  alertHeader.style.border = `2px solid ${colorScheme.border}`;
  alertHeader.style.borderLeft = `4px solid ${colorScheme.border}`;
  alertHeader.style.backgroundColor = colorScheme.bg;

  // Populate alert info
  alertTitle.textContent = alert.title;
  // Use details.severity if available, otherwise capitalize type
  const severityText = alert.details && alert.details.severity ? alert.details.severity : (alert.type.charAt(0).toUpperCase() + alert.type.slice(1));
  alertBadge.textContent = severityText;
  alertBadge.className = `alert-badge-detail alert-badge-${alert.type}`;
  alertLocation.textContent = `${alert.location}, ${alert.country}`;
  alertDescription.textContent = alert.description;
  
  console.log("Loading alert:", alert); // Debug log

  // Safety Instructions
  if(alert.instructions && alert.instructions.length) {
    instructionsCard.classList.remove('hidden');
    alert.instructions.forEach(instruction => {
      const li = document.createElement('li');
      li.textContent = instruction;
      instructionsList.appendChild(li);
    });
  }

  // Affected Areas
  if(alert.affectedAreas && alert.affectedAreas.length) {
    areasCard.classList.remove('hidden');
    alert.affectedAreas.forEach(area => {
      const span = document.createElement('span');
      span.className = 'badge-outline';
      span.textContent = area;
      affectedAreas.appendChild(span);
    });
  }

  // Expected Conditions
  if(alert.details) {
    detailsCard.classList.remove('hidden');
    const conditions = [];
    
    if(alert.details.windSpeed) {
      conditions.push({label: 'Wind Speed', value: alert.details.windSpeed, icon: 'ğŸ’¨'});
    }
    if(alert.details.precipitation) {
      conditions.push({label: 'Precipitation', value: alert.details.precipitation, icon: 'ğŸŒ§ï¸'});
    }
    if(alert.details.temperature) {
      conditions.push({label: 'Temperature', value: alert.details.temperature, icon: 'ğŸŒ¡ï¸'});
    }
    if(alert.details.heatIndex) {
      conditions.push({label: 'Heat Index', value: alert.details.heatIndex, icon: 'ğŸŒ¡ï¸'});
    }
    if(alert.details.humidity) {
      conditions.push({label: 'Humidity', value: alert.details.humidity, icon: 'ğŸ’§'});
    }
    if(alert.details.airQualityIndex) {
      conditions.push({label: 'Air Quality Index', value: alert.details.airQualityIndex, icon: 'ğŸŒ¬ï¸'});
    }
    if(alert.details.primaryPollutant) {
      conditions.push({label: 'Primary Pollutant', value: alert.details.primaryPollutant, icon: 'â˜ï¸'});
    }
    if(alert.details.visibility) {
      conditions.push({label: 'Visibility', value: alert.details.visibility, icon: 'ğŸ‘ï¸'});
    }

    conditions.forEach(cond => {
      const div = document.createElement('div');
      div.className = 'condition-card';
      div.innerHTML = `
        <span class="condition-icon">${cond.icon}</span>
        <div>
          <p class="condition-label">${cond.label}</p>
          <p class="condition-value">${cond.value}</p>
        </div>
      `;
      weatherConditions.appendChild(div);
    });

    // Alert Classification
    if(alert.details.severity || alert.details.urgency || alert.details.certainty) {
      classificationCard.classList.remove('hidden');
      if(alert.details.severity) {
        severity.textContent = alert.details.severity;
        severity.className = 'classification-badge badge-gray';
      }
      if(alert.details.urgency) {
        urgency.textContent = alert.details.urgency;
        urgency.className = 'classification-badge badge-gray';
      }
      if(alert.details.certainty) {
        certainty.textContent = alert.details.certainty;
        certainty.className = 'classification-badge badge-gray';
      }
    }
  }

  // Issued By
  if(alert.issuedBy) {
    issuedByCard.classList.remove('hidden');
    issuedBy.textContent = alert.issuedBy;
  }

  // Time Details
  issuedTime.textContent = `${alert.issuedHoursAgo} hour${alert.issuedHoursAgo !== 1 ? 's' : ''} ago`;
  effectivePeriod.textContent = alert.effectivePeriod;

  // Share functionality
  shareBtn.addEventListener('click', () => {
    const text = `${alert.title} - ${alert.location}, ${alert.country}: ${alert.description}`;
    if(navigator.share) {
      navigator.share({title: alert.title, text: text});
    } else {
      navigator.clipboard.writeText(text);
      alert("Alert copied to clipboard");
    }
  });
}
</script>

</body>
</html>
