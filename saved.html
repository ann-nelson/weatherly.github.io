<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weatherly - Dashboard</title>
  <link rel="stylesheet" href="stylesheet/global.css">

  <!-- SHARED MOCK DATA INITIALIZER -->
  <script src="mockData.js"></script>
</head>
<body>

<!-- Top Navigation -->
<header class="top-nav">
  <div class="logo">‚òÅÔ∏è<h1>Weatherly</h1></div>
  <nav class="nav-links">
    <a href="saved.html" class="active">Dashboard</a>
    <a href="search.html">Search</a>
    <a href="pastWeather.html">Past Weather</a>
    <a href="weatherAlerts.html">Alerts</a>
    <a href="settings.html">Settings</a>
    <a href="help.html">Help</a>
  </nav>
  <div class="user-section">
    <button onclick="window.location.href='profile.html'" class="profile-btn">Demo User</button>
    <button onclick="window.location.href='login.html'" class="logout-btn">Logout</button>
  </div>
</header>

<main class="main-container">
  <!-- Header -->
  <header class="section-header">
    <h2>My Locations</h2>
    <p id="locationsInfo">Manage your top 3 of 5 saved locations</p>
  </header>

  <!-- Reset Demo Button -->
  <button id="resetDemoBtn" class="btn-outline" style="margin-bottom: 20px;">
    Reset Demo Locations
  </button>

  <!-- Locations Grid -->
  <div id="locationsContainer" class="locations-grid"></div>
</main>

<script>
/* -------- Constants -------- */
const MAX_LOCATIONS = 5;
const STORAGE_KEY = 'weatherlySavedLocations';

/* -------- Default Demo Locations -------- */
const defaultDemoLocations = [
  {id:'1', name:'New York', country:'USA', temp:72, condition:'Partly Cloudy', high:75, low:65, humidity:65, windSpeed:12, icon:'‚õÖ'},
  {id:'2', name:'London', country:'UK', temp:61, condition:'Rainy', high:64, low:58, humidity:85, windSpeed:15, icon:'üåßÔ∏è'},
  {id:'3', name:'Tokyo', country:'Japan', temp:68, condition:'Sunny', high:73, low:62, humidity:55, windSpeed:8, icon:'‚òÄÔ∏è'}
];

/* -------- Saved Locations (load or seed) -------- */
let locations = JSON.parse(localStorage.getItem(STORAGE_KEY));

if (!locations || !Array.isArray(locations) || locations.length === 0) {
  // First visit or empty storage: seed with demo defaults
  locations = [...defaultDemoLocations];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(locations));
}

/* -------- Extra sample (not saved yet) -------- */
let extraSampleLocations = [
  {id:'4', name:'Sydney', country:'Australia', temp:78, condition:'Sunny', high:82, low:70, humidity:45, windSpeed:10, icon:'‚òÄÔ∏è'},
  {id:'5', name:'Toronto', country:'Canada', temp:59, condition:'Cloudy', high:63, low:54, humidity:72, windSpeed:14, icon:'‚òÅÔ∏è'}
];

/* DOM */
const locationsContainer = document.getElementById('locationsContainer');
const locationsInfo = document.getElementById('locationsInfo');
const resetDemoBtn = document.getElementById('resetDemoBtn');

function saveLocations() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(locations));
}

/* Render */
function renderLocations() {
  locationsContainer.innerHTML = '';
  const displayedLocations = locations.slice(0, MAX_LOCATIONS);

  locationsInfo.textContent = `Your top ${displayedLocations.length} of ${MAX_LOCATIONS} saved locations`;

  displayedLocations.forEach(loc => {
    const card = document.createElement('div');
    card.className = 'location-card';
    card.innerHTML = `
      <div class="card-saved">
        <div class="card-header">
          <div>
            <h3>${loc.name}</h3>
            <p>${loc.country}</p>
          </div>
          <div class="loc-icon">${loc.icon}</div>
        </div>

        <div class="card-body">
          <div class="temp-condition">
            <span class="temp">${loc.temp}¬∞</span>
            <span class="condition">${loc.condition}</span>
          </div>
          <div class="high-low">
            <span>H: ${loc.high}¬∞</span>
            <span>L: ${loc.low}¬∞</span>
          </div>
          <div class="metrics">
            <span>Humidity: ${loc.humidity}%</span>
            <span>Wind: ${loc.windSpeed} mph</span>
          </div>
        </div>
      </div>
      <div>
        <button class="view-weekly-btn">7-Day Forecast</button>
        <button class="remove-btn" data-id="${loc.id}">Remove</button>
      </div>
    `;

    locationsContainer.appendChild(card);

    // Remove location
    card.querySelector('.remove-btn').addEventListener('click', e => {
      const id = e.target.dataset.id;
      locations = locations.filter(l => l.id !== id);
      saveLocations();
      renderLocations();
    });

    // Weekly Forecast handoff
    const weeklyBtn = card.querySelector('.view-weekly-btn');
    weeklyBtn.addEventListener('click', () => {
      const currentWeather = {
        location: `${loc.name}, ${loc.country}`,
        temp: loc.temp,
        condition: loc.condition,
        high: loc.high,
        low: loc.low,
        humidity: loc.humidity,
        wind: loc.windSpeed,
        icon: loc.icon
      };

      // Simple sample weekly forecast derived from this location
      const weeklyForecast = [
        { day: "Mon", high: loc.high,     low: loc.low,     condition: loc.condition,         icon: loc.icon },
        { day: "Tue", high: loc.high+1,   low: loc.low-1,   condition: "Partly Cloudy",       icon: "‚õÖ" },
        { day: "Wed", high: loc.high+2,   low: loc.low,     condition: "Light Rain",          icon: "üåßÔ∏è" },
        { day: "Thu", high: loc.high-1,   low: loc.low-2,   condition: "Thunderstorm",        icon: "‚õàÔ∏è" },
        { day: "Fri", high: loc.high,     low: loc.low-1,   condition: "Sunny",               icon: "‚òÄÔ∏è" },
        { day: "Sat", high: loc.high-2,   low: loc.low-3,   condition: "Partly Cloudy",       icon: "‚õÖ" },
        { day: "Sun", high: loc.high-1,   low: loc.low-2,   condition: "Sunny",               icon: "‚òÄÔ∏è" }
      ];

      localStorage.setItem('selectedLocationWeather', JSON.stringify(currentWeather));
      localStorage.setItem('selectedLocationWeekly', JSON.stringify(weeklyForecast));

      window.location.href = 'weeklyForecast.html';
    });
  });

  /* ----- Add Location Card (if room) ----- */
  if (locations.length < MAX_LOCATIONS) {
    const remaining = MAX_LOCATIONS - locations.length;

    const addCard = document.createElement('div');
    addCard.className = 'add-card';
    addCard.innerHTML = `
      <div class="add-content">
        <span class="plus">+</span>
        <p>Add Location</p>
        <small>${remaining} slot${remaining !== 1 ? 's' : ''} remaining</small>
      </div>
    `;

    addCard.addEventListener('click', showSearchBar);
    locationsContainer.appendChild(addCard);
  }

  // Persist whenever we re-render
  saveLocations();
}

/* ---- SHOW SEARCH BAR ---- */
function showSearchBar() {
  const searchWrapper = document.createElement('div');
  searchWrapper.className = 'search-wrapper';

  searchWrapper.innerHTML = `
    <input id="locSearchInput" class="search-input" type="text" placeholder="Search location...">
    <button id="locSearchBtn" class="search-btn">Search</button>
    <p id="searchError" class="search-error" style="color:red;display:none;">Location not found</p>
  `;

  locationsContainer.appendChild(searchWrapper);

  document.getElementById('locSearchBtn').addEventListener('click', handleSearch);
}

/* ---- SEARCH HANDLER (sample locations) ---- */
function handleSearch() {
  const query = document.getElementById('locSearchInput').value.trim().toLowerCase();
  const error = document.getElementById('searchError');

  const allowed = extraSampleLocations.map(l => l.name.toLowerCase());

  if (!allowed.includes(query)) {
    error.textContent = 'Location not found';
    error.style.display = 'block';
    return;
  }

  if (locations.length >= MAX_LOCATIONS) {
    error.textContent = 'You can only save up to 5 locations.';
    error.style.display = 'block';
    return;
  }

  error.style.display = 'none';

  const found = extraSampleLocations.find(l => l.name.toLowerCase() === query);

  // Avoid duplicates by id
  if (locations.some(l => l.id === found.id)) {
    error.textContent = 'This location is already saved.';
    error.style.display = 'block';
    return;
  }

  locations.push(found);
  extraSampleLocations = extraSampleLocations.filter(l => l.id !== found.id);

  saveLocations();
  renderLocations();
}

/* ---- RESET DEMO LOCATIONS BUTTON ---- */
resetDemoBtn.addEventListener('click', () => {
  if (!confirm('Reset to default demo locations?')) return;

  locations = [...defaultDemoLocations];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(locations));
  renderLocations();
  alert('Dashboard reset to demo defaults!');
});

renderLocations();
</script>

</body>
</html>

